minimum_pre_commit_version: "3.5.0"

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: check-merge-conflict
      - id: check-json
      - id: check-yaml
      - id: end-of-file-fixer
      - id: trailing-whitespace
      - id: check-added-large-files

  - repo: local
    hooks:
      - id: api-lint
        name: API lint + format check
        entry: bash -lc 'cd apps/api && uv run ruff check src tests && uv run ruff format --check src tests'
        language: system
        pass_filenames: false
        files: ^apps/api/
        stages: [pre-commit]

      - id: web-lint-typecheck
        name: Web lint + typecheck
        entry: bash -lc 'source ~/.nvm/nvm.sh && nvm use default --silent && pnpm --filter @biblical-evals/web lint && pnpm --filter @biblical-evals/web typecheck'
        language: system
        pass_filenames: false
        files: ^(apps/web/|apps/web/package.json|package.json|pnpm-lock.yaml|pnpm-workspace.yaml)
        stages: [pre-commit]

      - id: api-tests-coverage
        name: API tests with coverage gate
        entry: bash -lc 'cd apps/api && uv run pytest -v --cov=src --cov-report=term-missing --cov-fail-under=85'
        language: system
        pass_filenames: false
        files: ^apps/api/
        stages: [pre-push]

      - id: web-tests-coverage
        name: Web tests with coverage gate
        entry: bash -lc 'source ~/.nvm/nvm.sh && nvm use default --silent && pnpm --filter @biblical-evals/web test:coverage'
        language: system
        pass_filenames: false
        files: ^(apps/web/|apps/web/package.json|package.json|pnpm-lock.yaml|pnpm-workspace.yaml)
        stages: [pre-push]

      - id: web-build
        name: Web production build
        entry: bash -lc 'source ~/.nvm/nvm.sh && nvm use default --silent && pnpm --filter @biblical-evals/web build'
        language: system
        pass_filenames: false
        files: ^(apps/web/|apps/web/package.json|package.json|pnpm-lock.yaml|pnpm-workspace.yaml)
        stages: [pre-push]

      - id: terraform-validate
        name: Terraform fmt + validate
        entry: bash -lc 'cd terraform && terraform fmt -check -recursive && terraform init -backend=false && terraform validate'
        language: system
        pass_filenames: false
        files: ^terraform/
        stages: [pre-push]
