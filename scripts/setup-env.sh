#!/usr/bin/env bash
set -euo pipefail

# Setup environment variables for biblical-evals.
#
# Reads from root .env first, then fills gaps from GCP Secret Manager.
# Generates .env.local files for both apps/api/ and apps/web/.
#
# Usage:
#   ./scripts/setup-env.sh              # Generate local .env files
#   ./scripts/setup-env.sh --vercel     # Also push to Vercel
#
# Prerequisites:
#   - Root .env file (copy from .env.example) OR gcloud authenticated
#   - vercel CLI authenticated (only if --vercel flag used)

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
ROOT_ENV="$ROOT_DIR/.env"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info()  { echo -e "${GREEN}[+]${NC} $*"; }
warn()  { echo -e "${YELLOW}[!]${NC} $*"; }
error() { echo -e "${RED}[x]${NC} $*" >&2; }

# ---------------------------------------------------------------------------
# Load root .env if it exists
# ---------------------------------------------------------------------------
if [[ -f "$ROOT_ENV" ]]; then
  info "Loading root .env ..."
  set -a
  # shellcheck source=/dev/null
  source "$ROOT_ENV"
  set +a
fi

PROJECT_ID="${GCP_PROJECT_ID:-trainerlab-prod}"
REGION="${GCP_REGION:-us-west1}"

# ---------------------------------------------------------------------------
# Fetch secrets from GCP Secret Manager (returns empty string if not found)
# ---------------------------------------------------------------------------
fetch_secret() {
  local secret_id="$1"
  gcloud secrets versions access latest \
    --secret="$secret_id" \
    --project="$PROJECT_ID" 2>/dev/null || echo ""
}

# ---------------------------------------------------------------------------
# Fetch Cloud Run URL
# ---------------------------------------------------------------------------
fetch_api_url() {
  gcloud run services describe biblical-evals-api \
    --region="$REGION" \
    --project="$PROJECT_ID" \
    --format='value(status.url)' 2>/dev/null || echo ""
}

# ---------------------------------------------------------------------------
# Resolve a value: use env var if set, otherwise fetch from GCP
# ---------------------------------------------------------------------------
resolve() {
  local env_value="$1"
  local gcp_secret="$2"
  if [[ -n "$env_value" ]]; then
    echo "$env_value"
  else
    fetch_secret "$gcp_secret"
  fi
}

# ---------------------------------------------------------------------------
# Main
# ---------------------------------------------------------------------------
PUSH_VERCEL=false
if [[ "${1:-}" == "--vercel" ]]; then
  PUSH_VERCEL=true
fi

info "Resolving secrets (root .env → GCP Secret Manager fallback)..."

NEXTAUTH_SECRET=$(resolve "${NEXTAUTH_SECRET:-}" "biblical-evals-nextauth-secret")
ADMIN_EMAILS="${ADMIN_EMAILS:-xdtsong@gmail.com,daniel@appraisehq.ai}"
OPENAI_API_KEY=$(resolve "${OPENAI_API_KEY:-}" "biblical-evals-openai-api-key")
ANTHROPIC_API_KEY=$(resolve "${ANTHROPIC_API_KEY:-}" "biblical-evals-anthropic-api-key")
GOOGLE_AI_API_KEY=$(resolve "${GOOGLE_AI_API_KEY:-}" "biblical-evals-google-ai-api-key")
DB_PASSWORD=$(fetch_secret "biblical-evals-db-password")
API_URL="${CLOUD_RUN_API_URL:-$(fetch_api_url)}"

# Fallbacks for local dev
LOCAL_API_URL="http://localhost:8000"
LOCAL_WEB_URL="http://localhost:3000"
LOCAL_DB_URL="postgresql+asyncpg://postgres:postgres@localhost:5432/biblical_evals"

PROD_WEB_URL="${VERCEL_WEB_URL:-https://biblical-evals.vercel.app}"

# ---------------------------------------------------------------------------
# Generate apps/api/.env.local
# ---------------------------------------------------------------------------
info "Writing apps/api/.env.local ..."

cat > "$ROOT_DIR/apps/api/.env.local" <<EOF
# Generated by scripts/setup-env.sh — do not commit
ENVIRONMENT=development
DEBUG=true

# Database (local Postgres)
DATABASE_URL=${LOCAL_DB_URL}

# Auth (shared with NextAuth.js)
NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-dev-secret-change-in-production}
ADMIN_EMAILS=${ADMIN_EMAILS}

# CORS
CORS_ORIGINS=${LOCAL_WEB_URL}

# LLM API Keys
OPENAI_API_KEY=${OPENAI_API_KEY}
ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
GOOGLE_API_KEY=${GOOGLE_AI_API_KEY}
EOF

# ---------------------------------------------------------------------------
# Generate apps/web/.env.local
# ---------------------------------------------------------------------------
info "Writing apps/web/.env.local ..."

cat > "$ROOT_DIR/apps/web/.env.local" <<EOF
# Generated by scripts/setup-env.sh — do not commit
NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-dev-secret-change-in-production}
NEXTAUTH_URL=${LOCAL_WEB_URL}

# Google OAuth
AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID:-}
AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET:-}

# Backend API
NEXT_PUBLIC_API_URL=${LOCAL_API_URL}
EOF

info "Local .env files written."

# Report what's set vs missing
echo ""
echo "  Secret status:"
[[ -n "$NEXTAUTH_SECRET" ]]  && info "  NEXTAUTH_SECRET    set" || warn "  NEXTAUTH_SECRET    missing (using dev fallback)"
[[ -n "$OPENAI_API_KEY" ]]   && info "  OPENAI_API_KEY     set" || warn "  OPENAI_API_KEY     missing"
[[ -n "$ANTHROPIC_API_KEY" ]]&& info "  ANTHROPIC_API_KEY  set" || warn "  ANTHROPIC_API_KEY  missing"
[[ -n "$GOOGLE_AI_API_KEY" ]]&& info "  GOOGLE_AI_API_KEY  set" || warn "  GOOGLE_AI_API_KEY  missing"
[[ -n "$DB_PASSWORD" ]]      && info "  DB_PASSWORD        set (Cloud SQL)" || warn "  DB_PASSWORD        missing (not needed locally)"
[[ -n "${AUTH_GOOGLE_ID:-}" ]]     && info "  AUTH_GOOGLE_ID     set" || warn "  AUTH_GOOGLE_ID     missing"
[[ -n "${AUTH_GOOGLE_SECRET:-}" ]] && info "  AUTH_GOOGLE_SECRET set" || warn "  AUTH_GOOGLE_SECRET missing"
[[ -n "$API_URL" ]]          && info "  Cloud Run URL      $API_URL" || warn "  Cloud Run URL      not deployed yet"
echo ""

# ---------------------------------------------------------------------------
# Push to Vercel
# ---------------------------------------------------------------------------
if [[ "$PUSH_VERCEL" == true ]]; then
  if ! command -v vercel &>/dev/null; then
    error "vercel CLI not found. Install: npm i -g vercel"
    exit 1
  fi

  PROD_API_URL="${API_URL:-https://biblical-evals-api-CHANGEME.run.app}"

  info "Pushing environment variables to Vercel (production)..."

  echo -n "$PROD_API_URL"                    | vercel env add NEXT_PUBLIC_API_URL production --force 2>/dev/null || true
  echo -n "${NEXTAUTH_SECRET}"               | vercel env add NEXTAUTH_SECRET production --force 2>/dev/null || true
  echo -n "$PROD_WEB_URL"                    | vercel env add NEXTAUTH_URL production --force 2>/dev/null || true
  echo -n "${AUTH_GOOGLE_ID:-}"              | vercel env add AUTH_GOOGLE_ID production --force 2>/dev/null || true
  echo -n "${AUTH_GOOGLE_SECRET:-}"          | vercel env add AUTH_GOOGLE_SECRET production --force 2>/dev/null || true

  info "Vercel env vars pushed. Redeploy to pick up changes."
fi

info "Done. Files written:"
echo "  $ROOT_DIR/apps/api/.env.local"
echo "  $ROOT_DIR/apps/web/.env.local"
